<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Python | WangChang's Blog]]></title>
  <link href="http://wangchang.github.com/blog/categories/python/atom.xml" rel="self"/>
  <link href="http://wangchang.github.com/"/>
  <updated>2012-12-11T14:10:26+08:00</updated>
  <id>http://wangchang.github.com/</id>
  <author>
    <name><![CDATA[Wang Chang]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[python routes 2 RESTful services]]></title>
    <link href="http://wangchang.github.com/blog/2012/11/python-routes-2-restful-services/"/>
    <updated>2012-11-29T18:37:00+08:00</updated>
    <id>http://wangchang.github.com/blog/2012/11/python-routes-2-restful-services</id>
    <content type="html"><![CDATA[<p>这一节主要讲讲用Routes来配置RESTful web services。<code>map.resource</code>可以根据Atom publishing protocol协议来创建一个<code>创建/修改/删除</code>的routes。也就是说根据resource来配置routes。</p>

<!--more-->


<h2>Resource</h2>

<p>一个resource route定义了一个collection中的成员member，以及一个collection自身。一般来说，一个collection就是一个复数单词，一个member就是相应的一个单数词，举例：</p>

<p>在restful服务中，我定义了关于虚拟连接VC的一些API。那么
* resoure:vc,vcs
* collection:vcs
* member:vc
再看看一个复杂点的例子：
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="nb">map</span> <span class="o">=</span> <span class="n">Mapper</span><span class="p">()</span>
</span><span class='line'><span class="nb">map</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s">&quot;message&quot;</span><span class="p">,</span> <span class="s">&quot;messages&quot;</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">The</span> <span class="n">above</span> <span class="n">command</span> <span class="n">sets</span> <span class="n">up</span> <span class="n">several</span> <span class="n">routes</span> <span class="k">as</span> <span class="k">if</span> <span class="n">you</span> <span class="n">had</span> <span class="n">typed</span> <span class="n">the</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">following</span> <span class="n">commands</span><span class="p">:</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;messages&quot;</span><span class="p">,</span> <span class="s">&quot;/messages&quot;</span><span class="p">,</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">controller</span><span class="o">=</span><span class="s">&quot;messages&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;create&quot;</span><span class="p">,</span>
</span><span class='line'><span class="n">conditions</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;POST&quot;</span><span class="p">]))</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;messages&quot;</span><span class="p">,</span> <span class="s">&quot;/messages&quot;</span><span class="p">,</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">controller</span><span class="o">=</span><span class="s">&quot;messages&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;index&quot;</span><span class="p">,</span>
</span><span class='line'><span class="n">conditions</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">]))</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;formatted_messages&quot;</span><span class="p">,</span> <span class="s">&quot;/messages.{format}&quot;</span><span class="p">,</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">controller</span><span class="o">=</span><span class="s">&quot;messages&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;index&quot;</span><span class="p">,</span>
</span><span class='line'><span class="n">conditions</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">]))</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;new_message&quot;</span><span class="p">,</span> <span class="s">&quot;/messages/new&quot;</span><span class="p">,</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">controller</span><span class="o">=</span><span class="s">&quot;messages&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;new&quot;</span><span class="p">,</span>
</span><span class='line'><span class="n">conditions</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">]))</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;formatted_new_message&quot;</span><span class="p">,</span> <span class="s">&quot;/messages/new.{format}&quot;</span><span class="p">,</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">controller</span><span class="o">=</span><span class="s">&quot;messages&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;new&quot;</span><span class="p">,</span>
</span><span class='line'><span class="n">conditions</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">]))</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;/messages/{id}&quot;</span><span class="p">,</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">controller</span><span class="o">=</span><span class="s">&quot;messages&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;update&quot;</span><span class="p">,</span>
</span><span class='line'><span class="n">conditions</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;PUT&quot;</span><span class="p">]))</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;/messages/{id}&quot;</span><span class="p">,</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">controller</span><span class="o">=</span><span class="s">&quot;messages&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;delete&quot;</span><span class="p">,</span>
</span><span class='line'><span class="n">conditions</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;DELETE&quot;</span><span class="p">]))</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;edit_message&quot;</span><span class="p">,</span> <span class="s">&quot;/messages/{id}/edit&quot;</span><span class="p">,</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">controller</span><span class="o">=</span><span class="s">&quot;messages&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;edit&quot;</span><span class="p">,</span>
</span><span class='line'><span class="n">conditions</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">]))</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;formatted_edit_message&quot;</span><span class="p">,</span> <span class="s">&quot;/messages/{id}.{format}/edit&quot;</span><span class="p">,</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">controller</span><span class="o">=</span><span class="s">&quot;messages&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;edit&quot;</span><span class="p">,</span>
</span><span class='line'><span class="n">conditions</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">]))</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;message&quot;</span><span class="p">,</span> <span class="s">&quot;/messages/{id}&quot;</span><span class="p">,</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">controller</span><span class="o">=</span><span class="s">&quot;messages&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;show&quot;</span><span class="p">,</span>
</span><span class='line'><span class="n">conditions</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">]))</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;formatted_message&quot;</span><span class="p">,</span> <span class="s">&quot;/messages/{id}.{format}&quot;</span><span class="p">,</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">controller</span><span class="o">=</span><span class="s">&quot;messages&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;show&quot;</span><span class="p">,</span>
</span><span class='line'><span class="n">conditions</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">]))</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>看到这里，我们可以推断出这么几个名词的定义：
* <strong>controller:就是一个WSGI的应用
* </strong>resource(s):就是REST API中的名词
* <strong>method:就是HTTP的方法，GET POST等
* </strong>action:Routes中与method对应，比如GET就对应"index"动作
* __collection:等同于resources。</p>

<p>上面的代码建立了如下的转换关系：
<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>- awesome.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="no">GET</span>    <span class="sr">/messages        =&gt; messages.index()    =&gt; url(&quot;messages&quot;)</span>
</span><span class='line'><span class="sr">POST   /mess</span><span class="n">ages</span>        <span class="o">=&gt;</span> <span class="n">messages</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>   <span class="o">=&gt;</span> <span class="n">url</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">)</span>
</span><span class='line'><span class="no">GET</span>    <span class="sr">/messages/ne</span><span class="n">w</span>    <span class="o">=&gt;</span> <span class="n">messages</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>      <span class="o">=&gt;</span> <span class="n">url</span><span class="p">(</span><span class="s2">&quot;new_message&quot;</span><span class="p">)</span>
</span><span class='line'><span class="no">PUT</span>    <span class="sr">/messages/</span><span class="mi">1</span>      <span class="o">=&gt;</span> <span class="n">messages</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">url</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="no">DELETE</span> <span class="sr">/messages/</span><span class="mi">1</span>      <span class="o">=&gt;</span> <span class="n">messages</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">url</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="no">GET</span>    <span class="sr">/messages/</span><span class="mi">1</span>      <span class="o">=&gt;</span> <span class="n">messages</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>   <span class="o">=&gt;</span> <span class="n">url</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="no">GET</span>    <span class="sr">/messages/</span><span class="mi">1</span><span class="o">/</span><span class="n">edit</span> <span class="o">=&gt;</span> <span class="n">messages</span><span class="o">.</span><span class="n">edit</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>   <span class="o">=&gt;</span> <span class="n">url</span><span class="p">(</span><span class="s2">&quot;edit_message&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
我们很明显的看到，这个<code>messages</code>就是一个WSGI应用，准确的来说，在代码中就是一个类的实例。</p>

<p>官网上有这么个解释，我就不翻译了：</p>

<blockquote><p>Thus, you GET the collection to see an index of links to members (“index” method). You GET a member to see it (“show”). You GET “COLLECTION/new” to obtain a new message form (“new”), which you POST to the collection (“create”). You GET “MEMBER/edit” to obtain an edit for (“edit”), which you PUT to the member (“update”). You DELETE the member to delete it. Note that there are only four route names because multiple actions are doubled up on the same URLs.</p></blockquote>

<h2>Resource选项。</h2>

<p>之前我们有<code>map.resource("message", "messages")</code>来增加了一个resource资源。可以增加一些参数。如下：
* <strong>controller
使用指定的controller，否则routes根据collection的名字来决定controller的名字。
* </strong>collection
为某以collection添加URL支持，如下：</p>

<pre><code>map.resource("message", "messages", collection={"rss": "GET"})
# "GET /message/rss"  =&gt;  ``Messages.rss()``.
# Defines a named route "rss_messages".自动定义
</code></pre>

<ul>
<li><p>__member
为一个member添加URL支持，如下：</p>

<p>  map.resource('message', 'messages', member={'mark':'POST'})
  # "POST /message/1/mark"  =>  <code>Messages.mark(1)</code>
  # also adds named route "mark_message"</p></li>
<li><p>__new
为新成员加入URL支持，如下：</p>

<p>  map.resource("message", "messages", new={"preview": "POST"})
  # "POST /messages/new/preview"</p></li>
<li><p>__path_prefix</p></li>
<li><p>__name_prefix</p>

<p>  map.resource("message", "messages", controller="categories",</p>

<pre><code> path_prefix="/category/{category_id}",
 name_prefix="category_")
</code></pre>

<p>  # GET /category/7/message/1
  # Adds named route "category_message"</p></li>
<li><p>__parenet_resource
一个包含父类资源的字典，用于创建嵌套（嵌入式）的资源。需要包含父类资源的member_name和collection_name，这个字典可以在请求的时候通过<code>request.environ["routes.route"]</code>访问。</p></li>
</ul>


<p>后面不是很懂了。。。
If parent_resource is supplied and path_prefix isn’t, path_prefix will be generated from parent_resource as “<parent collection name>/:<parent member name>_id”.</p>

<p>If parent_resource is supplied and name_prefix isn’t, name_prefix will be generated from parent_resource as “<parent member name>_”.
{}</p>

<blockquote><blockquote><blockquote><p>m = Mapper()
m.resource('location', 'locations',
...            parent_resource=dict(member_name='region',
...                                 collection_name='regions'))</p>

<h1>path_prefix is "regions/:region_id"</h1>

<h1>name prefix is "region_"</h1>

<p>url('region_locations', region_id=13)
'/regions/13/locations'
url('region_new_location', region_id=13)
'/regions/13/locations/new'
url('region_location', region_id=13, id=60)
'/regions/13/locations/60'
url('region_edit_location', region_id=13, id=60)
'/regions/13/locations/60/edit'</p></blockquote></blockquote></blockquote>

<p>Overriding generated path_prefix:</p>

<blockquote><blockquote><blockquote><p>m = Mapper()
m.resource('location', 'locations',
...            parent_resource=dict(member_name='region',
...                                 collection_name='regions'),
...            path_prefix='areas/:area_id')</p>

<h1>name prefix is "region_"</h1>

<p>url('region_locations', area_id=51)
'/areas/51/locations'</p></blockquote></blockquote></blockquote>

<p>Overriding generated name_prefix:</p>

<blockquote><blockquote><blockquote><p>m = Mapper()
m.resource('location', 'locations',
...            parent_resource=dict(member_name='region',
...                                 collection_name='regions'),
...            name_prefix='')</p>

<h1>path_prefix is "regions/:region_id"</h1>

<p>url('locations', region_id=51)
'/regions/51/locations'
{}</p></blockquote></blockquote></blockquote>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Python.Routes指南1 ]]></title>
    <link href="http://wangchang.github.com/blog/2012/11/python-routes-1-introduction/"/>
    <updated>2012-11-29T16:08:00+08:00</updated>
    <id>http://wangchang.github.com/blog/2012/11/python-routes-1-introduction</id>
    <content type="html"><![CDATA[<h2>什么是Routes</h2>

<p>用python重新实现的Rails Routes System，主要用来将URL映射到不同的应用动作（application actions）。特别适合于RESTFUL API。</p>

<p>Routes支持基于domain, cookies, HTTP method, 自定义function的映射。目前支持的功能：</p>

<p>Sophisticated route lookup and URL generation
Named routes
Redirect routes
Wildcard paths before and after static parts
Sub-domain support built-in
Conditional matching based on domain, cookies, HTTP method (RESTful), and more
Easily extensible utilizing custom condition functions and route generation functions
Extensive unit tests</p>

<p>安装：</p>

<pre><code>easy_install Routes
pip install Routes
</code></pre>

<h2>1 基本概念</h2>

<h3>component组件</h3>

<p>一个URL中的一个个组成部分，例如/blog/2012就有两个component:blog,2012</p>

<h3>generation</h3>

<p>基于route的名字或者变量的值创建一个URL，这个是match的反过程。</p>

<h3>mapper</h3>

<p>routes的容器，一般一个应用一个mapper，一个mapper知道如何去匹配routes或者产生routes.</p>

<h3>minimization</h3>

<p>允许短URL进行长路劲的匹配，已废弃。</p>

<h3>routes</h3>

<p>一个规则，将一个URL映射成为一个routing variables的字典，比如，规则是“/{controller}/{action}”，请求的URL是“/help/about”，那么结果字典就是：</p>

<pre><code>{"controller": "help", "action": "about"}
</code></pre>

<p>routes并不知道这些变量的含义，它只是把这个结果返回给应用。一个route可以拥有一个名字。</p>

<h3>route paths</h3>

<p>一条route中的URL模式（pattern）</p>

<h3>routing variables</h3>

<p>匹配之后返回的键值对。route path中定义的变量叫做path变量，他们的值来自URL中。route path外定义的变量叫做默认变量，其值不受URL影响。</p>

<p>特别注意！在WSGI中，用于route的关键字是environment（environ）中的wsgiorg.routing_args.</p>

<h2>2 简单的例子：</h2>

<pre><code># Setup a mapper
from routes import Mapper
map = Mapper()
map.connect(None, "/error/{action}/{id}, controller="error")
map.connect("home", "/", controller="main", action="index")
map.connect(None, "/{controller}/{action}")
map.connect(None, "/{controller}/{action}/{id}")


# Match a URL, returns a dict or None if no match
result = map.match('/error/myapp/4')
# result == {'controller': 'main', 'action': 'myapp', 'id': '4'}
</code></pre>

<p>对上面代码的一个简单解释：
1~2行创建了一个简单的mapper。</p>

<p>3行创建了一个以/error开始的任意三段的路由，并设置controller变量为一个常量！所以如果一个URL是<code>/error/images/arrow.jpg</code>，执行map.match（"/error/images/arrow.jpg"）得到的字典结果就会是：</p>

<p><code>{"controller": "error", "action": "images", "id": "arrow.jpg"}</code></p>

<p>4行创建了/的映射，并将controller和action设置为常量。而"home"表示此条route的名字。</p>

<p>6行匹配任务两端的URL。7行匹配任意三段的URL。所以前面的例子" “/error/images/arrow.jpg”"还能够匹配6、7行，在这种情况下，Routes采用的是以第一次匹配到的为准，顺序优先。</p>

<p>还有下面的例子：</p>

<pre><code>m.connect("/feeds/{category}/atom.xml", controller="feeds", action="atom")
m.connect("history", "/archives/by_eon/{century}", controller="archives",
      action="aggregate")
m.connect("article", "/article/{section}/{slug}/{page}.html",
      controller="article", action="view")
</code></pre>

<h2>3 初步深入</h2>

<h3>3.1 Magic path_info</h3>

<p>如果URL中使用了path_info，Routes会将先前的所有信息移动到“SCRIPT_NAME”这个环境变量中。当另外的WSGI应用有自己的routing的时候这个能起到很好的转移作用。看看如下的例子，用于WSGI环境。</p>

<pre><code>map.connect(None, "/cards/{path_info:.*}",
   controller="main", action="cards")
# Incoming URL "/cards/diamonds/4.png"
=&gt; {"controller": "main", action: "cards", "path_info": "/diamonds/4.png"}
# Second WSGI application sees:
# SCRIPT_NAME="/cards"   PATH_INFO="/diamonds/4.png"
</code></pre>

<h3>3.2 Condition条件匹配</h3>

<p>在一条route中，可以加入相应的条件，以加强匹配效果。condition是一个字典，最多只有以下三个关键字：
* method
大写的HTTP方法。
* sub_domain
这个目前不是很熟悉。
* function
三种方式使用如下：用一个函数来对请求进行处理，<code>func(environ, match_dict) =&gt; bool</code></p>

<p>{}</p>

<h1>Match only if the HTTP method is "GET" or "HEAD".</h1>

<p>m.connect("/user/list", controller="user", action="list",</p>

<pre><code>      conditions=dict(method=["GET", "HEAD"]))
</code></pre>

<h1>A sub-domain should be present.</h1>

<p>m.connect("/", controller="user", action="home",</p>

<pre><code>      conditions=dict(sub_domain=True))
</code></pre>

<h1>Sub-domain should be either "fred" or "george".</h1>

<p>m.connect("/", controller="user", action="home",</p>

<pre><code>      conditions=dict(sub_domain=["fred", "george"]))
</code></pre>

<h1>Put the referrer into the resulting match dictionary.</h1>

<h1>This function always returns true, so it never prevents the match</h1>

<h1>from succeeding.</h1>

<p>def referals(environ, result):</p>

<pre><code>result["referer"] = environ.get("HTTP_REFERER")
return True
</code></pre>

<p>m.connect("/{controller}/{action}/{id}",</p>

<pre><code>conditions=dict(function=referals))
</code></pre>

<p>{}</p>

<h3>3.3 在route中还可以使用通配符和正则表达式</h3>

<h3>3.4 格式扩展</h3>

<p>通过<code>{.format}</code>，可以匹配一个格式的扩展，比如.html或者.json。比如：</p>

<pre><code>map.connect('/entries/{id}{.format:json}')
</code></pre>

<p>就只会匹配到"/entries/1.json"。</p>

<h3>submapper</h3>

<h3>从子程序添加routes</h3>

<p>一个子程序可以传递给父程序一个routes的列表，通过mapper的<code>extend</code>方法，增加routes。如下：</p>

<pre><code>routes = [
   Route("index", "/index.html", controller="home", action="index"),
    ]

map.extend(routes)
# /index.html =&gt; {"controller": "home", "action": "index"}

map.extend(routes, "/subapp")
# /subapp/index.html =&gt; {"controller": "home", "action": "index"}
</code></pre>

<p><a href="http://routes.readthedocs.org/en/latest/setting_up.html">http://routes.readthedocs.org/en/latest/setting_up.html</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Python.Paste指南之WebOb(1)-概念]]></title>
    <link href="http://wangchang.github.com/blog/2012/11/python-paste-two-webob-1/"/>
    <updated>2012-11-21T16:56:00+08:00</updated>
    <id>http://wangchang.github.com/blog/2012/11/python-paste-two-webob-1</id>
    <content type="html"><![CDATA[<p>这次主要来学习Paste的核心内容，WebOb，内容依然来自官方翻译、网络参考以及自己的实践。</p>

<blockquote></blockquote>

<h2>What is WebOb?</h2>

<p>WebOb是一个Python库，主要是用在WSGI中对请求环境变量request environment（也就是WSGI应用中的参数environ）进行包装（提供wrapper），并提供了一个对象来方便的处理返回response消息。WebOb提供的对象映射了大多数的HTTP方法，包括头解析，content协商等。这里的映射，就是说只需要对对象进行操作，就可以完成HHTP的方法，从而大大简化开发难度。引用官方文档，WebOb有以下特点：</p>

<blockquote><p>Maps most of HTTP spec to friendly data structures.
Time-proven codebase that works around and hides all known WSGI quirks.
Zero known issues (reported bugs are always fixed ASAP).
100% test coverage.
No external dependencies.
Supports Python 3</p></blockquote>

<p>WebOb为HTTP的请求和相应提供了相应的对象。通过对WSGI request environment进行wrap来简化操作。</p>

<h2>Request</h2>

<p><code>webob.Request</code>对象是对WSGI environ dictionary的一个包装。后者这个字典以键值的形式描述了一个HTTP请求包括path信息和query string，以及一个与文件对象类似的秒速请求的body，以及一些其他的自定义keys。如下可以创建一个简单的Request对象。</p>

<pre><code>&gt;&gt;&gt;from webob import Request
&gt;&gt;&gt;environ = {'method': 'GET'}  
&gt;&gt;&gt;req = Request(environ) 
</code></pre>

<p>强调，<code>The request object wraps the environment</code>，仅仅是包装，所以你可以对这个environ进行读写的。可以通过req.environ可以访问到这个environ。但是一般都没必要这样做，直接用这个Request对象来操作就好了。如下：</p>

<pre><code>&gt;&gt;&gt;req.environ
{'method': 'GET'}
&gt;&gt;&gt;req.method 
'GET'
</code></pre>

<h2>此外，还有，req.accept_language, req.content_length, req.user_agent等。我们可以通过dir(req)来看看这个对象的方法咯。</h2>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>- awesome.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;blockquote&gt;&lt;blockquote&gt;&lt;blockquote&gt;&lt;p&gt;dir(req)</span>
</span><span class='line'><span class="sr">[&#39;GET&#39;, &#39;POST&#39;, &#39;ResponseClass&#39;, &#39;&lt;strong&gt;class&lt;/s</span><span class="n">trong</span><span class="o">&gt;</span><span class="s1">&#39;, &#39;</span><span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">delattr</span><span class="o">&lt;</span><span class="sr">/strong&gt;&#39;, &#39;&lt;strong&gt;dict&lt;/s</span><span class="n">trong</span><span class="o">&gt;</span><span class="s1">&#39;, &#39;</span><span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">doc</span><span class="o">&lt;</span><span class="sr">/strong&gt;&#39;, &#39;&lt;strong&gt;format&lt;/s</span><span class="n">trong</span><span class="o">&gt;</span><span class="s1">&#39;, &#39;</span><span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">getattr</span><span class="o">&lt;</span><span class="sr">/strong&gt;&#39;, &#39;&lt;strong&gt;getattribute&lt;/s</span><span class="n">trong</span><span class="o">&gt;</span><span class="s1">&#39;, &#39;</span><span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="nb">hash</span><span class="o">&lt;</span><span class="sr">/strong&gt;&#39;, &#39;&lt;strong&gt;init&lt;/s</span><span class="n">trong</span><span class="o">&gt;</span><span class="s1">&#39;, &#39;</span><span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">module</span><span class="o">&lt;</span><span class="sr">/strong&gt;&#39;, &#39;&lt;strong&gt;new&lt;/s</span><span class="n">trong</span><span class="o">&gt;</span><span class="s1">&#39;, &#39;</span><span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">reduce</span><span class="o">&lt;</span><span class="sr">/strong&gt;&#39;, &#39;&lt;strong&gt;reduce_ex&lt;/s</span><span class="n">trong</span><span class="o">&gt;</span><span class="s1">&#39;, &#39;</span><span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">repr</span><span class="o">&lt;</span><span class="sr">/strong&gt;&#39;, &#39;&lt;strong&gt;setattr&lt;/s</span><span class="n">trong</span><span class="o">&gt;</span><span class="s1">&#39;, &#39;</span><span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">sizeof</span><span class="o">&lt;</span><span class="sr">/strong&gt;&#39;, &#39;&lt;strong&gt;str&lt;/s</span><span class="n">trong</span><span class="o">&gt;</span><span class="s1">&#39;, &#39;</span><span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">subclasshook</span><span class="o">&lt;</span><span class="sr">/strong&gt;&#39;, &#39;&lt;strong&gt;weakref&lt;/s</span><span class="n">trong</span><span class="o">&gt;</span><span class="s1">&#39;, &#39;</span><span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="n">body__del</span><span class="s1">&#39;, &#39;</span><span class="o">&lt;</span><span class="sr">/em&gt;body&lt;strong&gt;get&#39;, &#39;_body&lt;/s</span><span class="n">trong</span><span class="o">&gt;</span><span class="n">set</span><span class="s1">&#39;, &#39;</span><span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="n">body_file__del</span><span class="s1">&#39;, &#39;</span><span class="o">&lt;</span><span class="sr">/em&gt;body_file&lt;strong&gt;get&#39;, &#39;_body_file&lt;/s</span><span class="n">trong</span><span class="o">&gt;</span><span class="n">set</span><span class="s1">&#39;, &#39;</span><span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="n">cache_control__del</span><span class="s1">&#39;, &#39;</span><span class="o">&lt;</span><span class="sr">/em&gt;cache_control&lt;strong&gt;get&#39;, &#39;_cache_control&lt;/s</span><span class="n">trong</span><span class="o">&gt;</span><span class="n">set</span><span class="s1">&#39;, &#39;</span><span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="n">charset</span><span class="s1">&#39;, &#39;</span><span class="o">&lt;</span><span class="sr">/em&gt;check_charset&#39;, &#39;&lt;em&gt;content_type__get&#39;, &#39;&lt;/em</span><span class="o">&gt;</span><span class="n">content_type</span><span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">set</span><span class="s1">&#39;, &#39;</span><span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="n">content_type_raw</span><span class="s1">&#39;, &#39;</span><span class="o">&lt;</span><span class="sr">/em&gt;copy_body_tempfile&#39;, &#39;&lt;em&gt;headers&#39;, &#39;&lt;/em</span><span class="o">&gt;</span><span class="n">headers</span><span class="o">&lt;</span><span class="sr">/strong&gt;get&#39;, &#39;&lt;em&gt;headers__set&#39;, &#39;&lt;/em</span><span class="o">&gt;</span><span class="n">host</span><span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">del</span><span class="s1">&#39;, &#39;</span><span class="n">_host</span><span class="o">&lt;</span><span class="sr">/strong&gt;get&#39;, &#39;&lt;em&gt;host__set&#39;, &#39;&lt;/em</span><span class="o">&gt;</span><span class="n">is_body_readable</span><span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">get</span><span class="s1">&#39;, &#39;</span><span class="n">_is_body_readable</span><span class="o">&lt;</span><span class="sr">/strong&gt;set&#39;, &#39;&lt;em&gt;json_body__del&#39;, &#39;&lt;/em</span><span class="o">&gt;</span><span class="n">json_body</span><span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">get</span><span class="s1">&#39;, &#39;</span><span class="n">_json_body</span><span class="o">&lt;</span><span class="sr">/strong&gt;set&#39;, &#39;&lt;em&gt;setattr_stacklevel&#39;, &#39;&lt;/em</span><span class="o">&gt;</span><span class="n">text</span><span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">del</span><span class="s1">&#39;, &#39;</span><span class="n">_text</span><span class="o">&lt;</span><span class="sr">/strong&gt;get&#39;, &#39;&lt;em&gt;text__set&#39;, &#39;&lt;/em</span><span class="o">&gt;</span><span class="n">update_cache_control</span><span class="s1">&#39;, &#39;</span><span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="n">urlargs__del</span><span class="s1">&#39;, &#39;</span><span class="o">&lt;</span><span class="sr">/em&gt;urlargs&lt;strong&gt;get&#39;, &#39;_urlargs&lt;/s</span><span class="n">trong</span><span class="o">&gt;</span><span class="n">set</span><span class="s1">&#39;, &#39;</span><span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="n">urlvars__del</span><span class="s1">&#39;, &#39;</span><span class="o">&lt;</span><span class="sr">/em&gt;urlvars&lt;strong&gt;get&#39;, &#39;_urlvars&lt;/s</span><span class="n">trong</span><span class="o">&gt;</span><span class="n">set</span><span class="s1">&#39;, &#39;</span><span class="n">accept</span><span class="s1">&#39;, &#39;</span><span class="n">accept_charset</span><span class="s1">&#39;, &#39;</span><span class="n">accept_encoding</span><span class="s1">&#39;, &#39;</span><span class="n">accept_language</span><span class="s1">&#39;, &#39;</span><span class="n">application_url</span><span class="s1">&#39;, &#39;</span><span class="n">as_bytes</span><span class="s1">&#39;, &#39;</span><span class="n">as_string</span><span class="s1">&#39;, &#39;</span><span class="n">as_text</span><span class="s1">&#39;, &#39;</span><span class="n">authorization</span><span class="s1">&#39;, &#39;</span><span class="n">blank</span><span class="s1">&#39;, &#39;</span><span class="n">body</span><span class="s1">&#39;, &#39;</span><span class="n">body_file</span><span class="s1">&#39;, &#39;</span><span class="n">body_file_raw</span><span class="s1">&#39;, &#39;</span><span class="n">body_file_seekable</span><span class="s1">&#39;, &#39;</span><span class="n">cache_control</span><span class="s1">&#39;, &#39;</span><span class="n">call_application</span><span class="s1">&#39;, &#39;</span><span class="n">charset</span><span class="s1">&#39;, &#39;</span><span class="n">client_addr</span><span class="s1">&#39;, &#39;</span><span class="n">content_length</span><span class="s1">&#39;, &#39;</span><span class="n">content_type</span><span class="s1">&#39;, &#39;</span><span class="n">cookies</span><span class="s1">&#39;, &#39;</span><span class="n">copy</span><span class="s1">&#39;, &#39;</span><span class="n">copy_body</span><span class="s1">&#39;, &#39;</span><span class="n">copy_get</span><span class="s1">&#39;, &#39;</span><span class="n">date</span><span class="s1">&#39;, &#39;</span><span class="n">decode</span><span class="s1">&#39;, &#39;</span><span class="n">encget</span><span class="s1">&#39;, &#39;</span><span class="n">encset</span><span class="s1">&#39;, &#39;</span><span class="n">environ</span><span class="s1">&#39;, &#39;</span><span class="n">from_bytes</span><span class="s1">&#39;, &#39;</span><span class="n">from_file</span><span class="s1">&#39;, &#39;</span><span class="n">from_string</span><span class="s1">&#39;, &#39;</span><span class="n">from_text</span><span class="s1">&#39;, &#39;</span><span class="n">get_response</span><span class="s1">&#39;, &#39;</span><span class="n">headers</span><span class="s1">&#39;, &#39;</span><span class="n">host</span><span class="s1">&#39;, &#39;</span><span class="n">host_port</span><span class="s1">&#39;, &#39;</span><span class="n">host_url</span><span class="s1">&#39;, &#39;</span><span class="n">http_version</span><span class="s1">&#39;, &#39;</span><span class="n">if_match</span><span class="s1">&#39;, &#39;</span><span class="n">if_modified_since</span><span class="s1">&#39;, &#39;</span><span class="n">if_none_match</span><span class="s1">&#39;, &#39;</span><span class="n">if_range</span><span class="s1">&#39;, &#39;</span><span class="n">if_unmodified_since</span><span class="s1">&#39;, &#39;</span><span class="n">is_body_readable</span><span class="s1">&#39;, &#39;</span><span class="n">is_body_seekable</span><span class="s1">&#39;, &#39;</span><span class="n">is_xhr</span><span class="s1">&#39;, &#39;</span><span class="n">json</span><span class="s1">&#39;, &#39;</span><span class="n">json_body</span><span class="s1">&#39;, &#39;</span><span class="n">make_body_seekable</span><span class="s1">&#39;, &#39;</span><span class="n">make_default_send_app</span><span class="s1">&#39;, &#39;</span><span class="n">make_tempfile</span><span class="s1">&#39;, &#39;</span><span class="n">max_forwards</span><span class="s1">&#39;, &#39;</span><span class="nb">method</span><span class="s1">&#39;, &#39;</span><span class="n">params</span><span class="s1">&#39;, &#39;</span><span class="n">path</span><span class="s1">&#39;, &#39;</span><span class="n">path_info</span><span class="s1">&#39;, &#39;</span><span class="n">path_info_peek</span><span class="s1">&#39;, &#39;</span><span class="n">path_info_pop</span><span class="s1">&#39;, &#39;</span><span class="n">path_qs</span><span class="s1">&#39;, &#39;</span><span class="n">path_url</span><span class="s1">&#39;, &#39;</span><span class="n">pragma</span><span class="s1">&#39;, &#39;</span><span class="n">query_string</span><span class="s1">&#39;, &#39;</span><span class="n">range</span><span class="s1">&#39;, &#39;</span><span class="n">referer</span><span class="s1">&#39;, &#39;</span><span class="n">referrer</span><span class="s1">&#39;, &#39;</span><span class="n">relative_url</span><span class="s1">&#39;, &#39;</span><span class="n">remote_addr</span><span class="s1">&#39;, &#39;</span><span class="n">remote_user</span><span class="s1">&#39;, &#39;</span><span class="n">remove_conditional_headers</span><span class="s1">&#39;, &#39;</span><span class="n">request_body_tempfile_limit</span><span class="s1">&#39;, &#39;</span><span class="n">scheme</span><span class="s1">&#39;, &#39;</span><span class="n">script_name</span><span class="s1">&#39;, &#39;</span><span class="nb">send</span><span class="s1">&#39;, &#39;</span><span class="n">server_name</span><span class="s1">&#39;, &#39;</span><span class="n">server_port</span><span class="s1">&#39;, &#39;</span><span class="n">str_GET</span><span class="s1">&#39;, &#39;</span><span class="n">str_POST</span><span class="s1">&#39;, &#39;</span><span class="n">str_cookies</span><span class="s1">&#39;, &#39;</span><span class="n">str_params</span><span class="s1">&#39;, &#39;</span><span class="n">text</span><span class="s1">&#39;, &#39;</span><span class="n">upath_info</span><span class="s1">&#39;, &#39;</span><span class="n">url</span><span class="s1">&#39;, &#39;</span><span class="n">url_encoding</span><span class="s1">&#39;, &#39;</span><span class="n">urlargs</span><span class="s1">&#39;, &#39;</span><span class="n">urlvars</span><span class="s1">&#39;, &#39;</span><span class="n">uscript_name</span><span class="s1">&#39;, &#39;</span><span class="n">user_agent</span><span class="err">&#39;</span><span class="o">]&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;h2&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></h2>

<p>一个WSGI的environ需要一些必须的参数，所以Request对象有一个构造器，在创建的时候就会自动添加最小的一些必要的项，如上，我们只指定了一个method，那么我们看看。</p></blockquote></blockquote></blockquote>

<pre><code>&gt;&gt;&gt; req
&lt;Request at 0x2bbb4d0 (invalid WSGI environ)&gt;
</code></pre>

<p>显示这个WSGI environ是无效的，因为缺少必要的信息。我们来调用构造器的方法：
<div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>req = Request.blank('/article?id=1')&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;blockquote>&lt;blockquote>&lt;blockquote>&lt;p>from pprint import pprint
</span><span class='line'>pprint(req.environ)
</span><span class='line'>{'HTTP_HOST': 'localhost:80',
</span><span class='line'> 'PATH_INFO': '/article',
</span><span class='line'> 'QUERY_STRING': 'id=1',
</span><span class='line'> 'REQUEST_METHOD': 'GET',
</span><span class='line'> 'SCRIPT_NAME': '',
</span><span class='line'> 'SERVER_NAME': 'localhost',
</span><span class='line'> 'SERVER_PORT': '80',
</span><span class='line'> 'SERVER_PROTOCOL': 'HTTP/1.0',
</span><span class='line'> 'wsgi.errors': &lt;open file '&lt;stderr>', mode 'w' at ...>,
</span><span class='line'> 'wsgi.input': &lt;...IO... object at ...>,
</span><span class='line'> 'wsgi.multiprocess': False,
</span><span class='line'> 'wsgi.multithread': False,
</span><span class='line'> 'wsgi.run_once': False,
</span><span class='line'> 'wsgi.url_scheme': 'http',
</span><span class='line'> 'wsgi.version': (1, 0)}</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h2>pprint用来打印字典等效果很好的。这里简单对url做一个说明，/article?id=1我们可以看到article是属于PATH中的，而?分割的是参数，也就是query_string。如果指定了多个参数，也是一起放在QUERY_STRING里面的，如下：</h2>

<p>{}
req = Request.blank('/article?id=1&amp;id=2')
pprint(req.environ)
{'HTTP_HOST': 'localhost:80',
 'PATH_INFO': '/article',
 'QUERY_STRING': 'id=1&amp;id=2',
 'REQUEST_METHOD': 'GET',
 'SCRIPT_NAME': '',
 'SERVER_NAME': 'localhost',
 'SERVER_PORT': '80',
 'SERVER_PROTOCOL': 'HTTP/1.0',
 'wsgi.errors': <open file '<stderr>', mode 'w' at 0x7f33b863a270>,
 'wsgi.input': &lt;_io.BytesIO object at 0x2b94e30>,
 'wsgi.multiprocess': False,
 'wsgi.multithread': False,
 'wsgi.run_once': False,
 'wsgi.url_scheme': 'http',
 'wsgi.version': (1, 0)}</p>

<h2>{}</h2>

<h2>Request body</h2>

<p>req.body是一个描述了请求body（比如，POST一个表单，PUT的内容）的一个类文件对象（file-like object），我们先把body设置为一个字符串，会被自动转换为一个类文件对象，通过req.body可以访问到body的内容。</p></blockquote></blockquote></blockquote>

<pre><code>&gt;&gt;&gt; req.body="this is body"
&gt;&gt;&gt; req.body
'this is body'
&gt;&gt;&gt; type(req.body)
&lt;type 'str'&gt;
</code></pre>

<h2>Method &amp; URL</h2>

<p>一个请求的所有属性都可以通过Request对象的属性来访问，这些属性如下：</p>

<h2>一个请求对象里面比较重要的属性有以下：</h2>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;blockquote>&lt;blockquote>&lt;blockquote>&lt;p>req.scheme
</span><span class='line'>'http'
</span><span class='line'>req.method
</span><span class='line'>'GET'
</span><span class='line'>req.GET
</span><span class='line'>GET([(u'id', u'1'), (u'id', u'2')])
</span><span class='line'>req.params
</span><span class='line'>NestedMultiDict([(u'id', u'1'), (u'id', u'2')])
</span><span class='line'>req.body
</span><span class='line'>'this is body'
</span><span class='line'>req.headers
</span><span class='line'>&lt;webob.headers.EnvironHeaders object at 0x2bbbc10>
</span><span class='line'>req.script_name  # The base of the URL
</span><span class='line'>''
</span><span class='line'>req.script_name = '/blog' # make it more interesting
</span><span class='line'>req.path_info    # The yet-to-be-consumed part of the URL
</span><span class='line'>'/article'
</span><span class='line'>req.content_type # Content-Type of the request body
</span><span class='line'>''
</span><span class='line'>req.host
</span><span class='line'>'localhost:80'
</span><span class='line'>req.host_url
</span><span class='line'>'http://localhost'
</span><span class='line'>req.application_url
</span><span class='line'>'http://localhost/blog'
</span><span class='line'>req.path_url
</span><span class='line'>'http://localhost/blog/article'
</span><span class='line'>req.url
</span><span class='line'>'http://localhost/blog/article?id=1'
</span><span class='line'>req.path
</span><span class='line'>'/blog/article'
</span><span class='line'>req.path_qs
</span><span class='line'>'/blog/article?id=1'
</span><span class='line'>req.query_string
</span><span class='line'>'id=1'&lt;/p>&lt;/blockquote>&lt;/blockquote>&lt;/blockquote>
</span><span class='line'>
</span><span class='line'>&lt;p>req.POST&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>req.cookies&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>req.urlvars或者req.urlargs&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;h2></span></code></pre></td></tr></table></div></figure></notextile></div></h2>

<p>对于一个URL，由于我们需要处理PATH_INFO，所以还有以下几种使用：</p>

<pre><code>&gt;&gt;&gt; req.path_info_peek() # Doesn't change request
'article'
&gt;&gt;&gt; req.path_info_pop()  # Does change request!
'article'
&gt;&gt;&gt; req.script_name
'/blog/article'
&gt;&gt;&gt; req.path_info #上面已经pop了，所以这里是空，否则应该是'/article'的。
''
</code></pre>

<h2>Headers</h2>

<p>一个请求的header主要是content的定义以及host的定义，可能还会带有一些认证信息。注意，这里的操作大小写敏感。</p>

<pre><code>&gt;&gt;&gt; req.headers['Content-Type'] = 'application/x-www-urlencoded'
&gt;&gt;&gt; req.headers.items()
[('Content-Length', '4'), ('Content-Type', 'application/x-www-urlencoded'), ('Host', 'localhost:80')]
&gt;&gt;&gt; req.environ['CONTENT_TYPE']
'application/x-www-urlencoded'
</code></pre>

<h2>Query &amp; POST</h2>

<p>请求可以在两个位置拥有变量，一个是query string（类似上面的?id=1）,二是在body里面（常用于POST表单），但是即便是POST请求也可以拥有query string。所以这两个位置都可能存在变量。并且一个变量可能出现多次，比如?check=a&amp;check=b。</p>

<p>对于上面的东西，WebOb使用了多字典（MultiDict）的形式。所谓MultiDict,就在把一个包含键值对的列表包装成一个字典，看起来就像一个单值字典（single valued dict），但是你可以获得某一个key的所有值，通过.getall(key)(始终返回一个列表)，也可以通过.items()来获得所有的键值对以及.values()获得所有的值。举个例子：</p>

<pre><code>&gt;&gt;&gt; req = Request.blank('/test?check=a&amp;check=b&amp;name=Bob')
&gt;&gt;&gt; req.GET
MultiDict([(u'check', u'a'), (u'check', u'b'), (u'name', u'Bob')])
&gt;&gt;&gt; req.GET['check']
u'b'
&gt;&gt;&gt; req.GET.getall('check')
[u'a', u'b']
&gt;&gt;&gt; req.GET.items()
[(u'check', u'a'), (u'check', u'b'), (u'name', u'Bob')]
&gt;&gt;&gt; req.GET.values()
[u'a', u'b', u'Bob']
</code></pre>

<p>接下来，我们把req变成一个POST请求。无非就是做两个事，一是更改method，一是给出body。</p>

<pre><code>&gt;&gt;&gt; req.POST
&lt;NoVars: Not a form request&gt;
&gt;&gt;&gt; req.POST.items()  # NoVars can be read like a dict, but not written
[]
&gt;&gt;&gt; req.method = 'POST'
&gt;&gt;&gt; req.body = 'name=Joe&amp;email=joe@example.com'
&gt;&gt;&gt; req.POST
MultiDict([(u'name', u'Joe'), (u'email', u'joe@example.com')])
&gt;&gt;&gt; req.POST['name']
u'Joe'
</code></pre>

<p>前面我们提到，一个请求的变量（也可以较为参数）可以存在于URL中也可以在Body中，如果我们不关系，变量的位置，那么用req.params就可以看到所有位置的变量，同样，也是通过MultiDict这种形式保存的。</p>

<pre><code>&gt;&gt;&gt; req.params
NestedMultiDict([(u'check', u'a'), (u'check', u'b'), (u'name', u'Bob'), (u'name', u'Joe'), (u'email', u'joe@example.com')])
&gt;&gt;&gt; req.params['name']
u'Bob'
&gt;&gt;&gt; req.params.getall('name')
[u'Bob', u'Joe']
&gt;&gt;&gt; for name, value in req.params.items():
...     print '%s: %r' % (name, value)
check: u'a'
check: u'b'
name: u'Bob'
name: u'Joe'
email: u'joe@example.com'
</code></pre>

<p>相对而言，这种方式还很简单一点。至于GET和POST，命名是历史遗留下的。req.GET也可以使用在非GET的请求中，从而来获得参数。如下：</p>

<pre><code>&gt;&gt;&gt; req = Request.blank('/test?check=a&amp;check=b&amp;name=Bob')
&gt;&gt;&gt; req.method = 'PUT'
&gt;&gt;&gt; req.body = body = 'var1=value1&amp;var2=value2&amp;rep=1&amp;rep=2'
&gt;&gt;&gt; req.environ['CONTENT_LENGTH'] = str(len(req.body))
&gt;&gt;&gt; req.environ['CONTENT_TYPE'] = 'application/x-www-form-urlencoded'
&gt;&gt;&gt; req.GET
MultiDict([(u'check', u'a'), (u'check', u'b'), (u'name', u'Bob')])
&gt;&gt;&gt; req.POST
MultiDict([(u'var1', u'value1'), (u'var2', u'value2'), (u'rep', u'1'), (u'rep', u'2')])
</code></pre>

<p>另外，应用中，应该强制使用UTF-8编码，也是通过制定字符集参数。</p>

<pre><code>&gt;&gt;&gt; req.charset = 'utf8'
&gt;&gt;&gt; req.GET
MultiDict([(u'check', u'a'), (u'check', u'b'), (u'name', u'Bob')])
</code></pre>

<p><a href="http://docs.webob.org/en/latest/reference.html#introduction">http://docs.webob.org/en/latest/reference.html#introduction</a>
<a href="http://docs.webob.org/en/latest/index.html">http://docs.webob.org/en/latest/index.html</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Python.Paste指南之Deploy(2)-实践]]></title>
    <link href="http://wangchang.github.com/blog/2012/11/python-paste-one-deploy-2/"/>
    <updated>2012-11-20T10:39:00+08:00</updated>
    <id>http://wangchang.github.com/blog/2012/11/python-paste-one-deploy-2</id>
    <content type="html"><![CDATA[<p>上一节中梳理了Python Paste中Deploy机制的概念，这一节就做一点小小的实践。首先，我们举一个使用了Deploy的例子，这个就是OpenStack的Quantum组件的WSGI部分。我们先来看关于WSGI部分的配置文件，以ini后缀，那么就是api-paste.ini文件，决定了API的处理流程。我加入了适当的注释。</p>

<!--more-->


<h2>1 OpenStack Quantum配置文件api-paste.ini</h2>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>- awesome.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;[composite:quantum]</span>
</span><span class='line'><span class="sr">use = egg:Paste#urlmap</span>
</span><span class='line'><span class="sr">/</span><span class="p">:</span> <span class="n">quantumversions</span>
</span><span class='line'><span class="sr">/v2.0: quantumapi_v2_0&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="err">使用</span><span class="n">composite</span><span class="err">分解机制，</span><span class="n">composite</span><span class="err">使用了</span><span class="n">usrlmap</span><span class="err">，</span><span class="n">xxxxx</span><span class="o">/</span><span class="n">xxx</span><span class="err">的</span><span class="no">API</span><span class="err">交给</span><span class="n">quantumversions</span><span class="err">处理。</span><span class="n">xxxx</span><span class="o">/</span><span class="n">v2</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">xxxx</span><span class="err">的</span><span class="no">API</span><span class="err">交给</span><span class="n">quantumapi_v2_0</span><span class="err">处理。</span><span class="o">&lt;</span><span class="sr">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;[composite:quantumapi_v2_0]</span>
</span><span class='line'><span class="sr">use = call:quantum.auth:pipeline_factory</span>
</span><span class='line'><span class="sr">noauth = extensions quantumapiapp_v2_0</span>
</span><span class='line'><span class="sr">keystone = authtoken keystonecontext extensions quantumapiapp_v2_0&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">quantumapi_v2_0</span><span class="err">依然是一个分解组件，使用了</span><span class="n">quantum</span><span class="o">.</span><span class="n">auth</span><span class="err">模块下的</span><span class="n">pipeline_factory</span><span class="err">，对于这个</span><span class="n">factory</span><span class="err">，传递了两个参数，一个是</span><span class="n">noauth</span><span class="p">,</span><span class="err">一个是</span><span class="n">keystone</span><span class="err">。</span><span class="o">&lt;</span><span class="sr">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;[filter:keystonecontext]</span>
</span><span class='line'><span class="sr">paste.filter_factory = quantum.auth:QuantumKeystoneContext.factory&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="err">对于</span><span class="n">keystonecontext</span><span class="err">，实际上是一个过滤器，使用了</span><span class="n">quantum</span><span class="o">.</span><span class="n">auth</span><span class="err">模块下的类</span><span class="no">QuantumKeystoneContext</span><span class="err">的</span><span class="n">factory</span><span class="err">函数</span><span class="o">&lt;</span><span class="sr">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;[filter:authtoken]</span>
</span><span class='line'><span class="sr">paste.filter_factory = keystone.middleware.auth_token:filter_factory</span>
</span><span class='line'><span class="sr">auth_host = 127.0.0.1</span>
</span><span class='line'><span class="sr">auth_port = 35357</span>
</span><span class='line'><span class="sr">auth_protocol = http</span>
</span><span class='line'><span class="sr">admin_tenant_name = %SERVICE_TENANT_NAME%</span>
</span><span class='line'><span class="sr">admin_user = %SERVICE_USER%</span>
</span><span class='line'><span class="sr">admin_password = %SERVICE_PASSWORD%&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="err">定义了另外一个</span><span class="n">filter</span><span class="o">&lt;</span><span class="sr">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;[filter:extensions]</span>
</span><span class='line'><span class="sr">paste.filter_factory = quantum.extensions.extensions:plugin_aware_extension_middleware_factory&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="err">定义了另外一个</span><span class="n">filter</span><span class="p">,</span><span class="err">这个</span><span class="n">filter</span><span class="err">是为了支持扩展</span><span class="n">quantum</span> <span class="n">api</span><span class="err">的</span><span class="o">&lt;</span><span class="sr">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;[app:quantumversions]</span>
</span><span class='line'><span class="sr">paste.app_factory = quantum.api.versions:Versions.factory&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="err">核心的</span><span class="n">app</span><span class="err">部分，使用工厂函数，将</span><span class="n">app</span><span class="err">指向</span><span class="n">python</span><span class="err">代码。</span><span class="n">app_factory</span><span class="err">表明这个函数接收一系列参数，</span><span class="o">[</span><span class="no">DEFAULET</span><span class="o">]</span><span class="err">以及</span><span class="o">[</span><span class="n">app</span><span class="p">:</span><span class="o">]</span><span class="err">下面的，本部分本</span><span class="n">section</span><span class="err">没有参数，并返回一个函数对象。</span><span class="o">&lt;</span><span class="sr">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;[app:quantumapiapp_v2_0]</span>
</span><span class='line'><span class="sr">paste.app_factory = quantum.api.v2.router:APIRouter.factory&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="err">同上</span><span class="o">&lt;</span><span class="sr">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>我们来总结一下，整个Quantum处理api的流程如下,其中，强调的部分为函数代码，其他为配置文件中的section部分。</p>

<p>对于路径为<code>/</code>类的API----quantumversions处理----调用<code>quantum.api.versions:Version</code>类的<code>factory函数</code>处理。</p>

<p>对于路径为<code>/2.0</code>类的API----quantumapi_v2_0处理----调用<code>quantum.auth</code>中的<code>pipeline_factory</code>处理,同时传递了两个参数noauth和keystone,类型为字典。
这个pipeline_factory中会读取另外一个变量CONF.auth（来自另外一个配置文件，不考虑），选择采用的认证方式，然后选择noauth或者keystone，并读取参数的值。
那么，就有两种情况：</p>

<p>noauth: 应用将会先经过extensions这个filter处理----调用了<code>quantum.extensions.extensions:plugin_aware_extension_middleware_factory</code>，用来处理扩展api请求，这是第一次包装----quantumapiapp_v2_0，这才是实际的WSGI应用，调用了<code>quantum.api.v2.router:APIRouter.factory</code>，并处理返回结果。</p>

<p>keystone：和上面类似，不同的是多了几个filter,authtoken keystonecontext extensions quantumapiapp_v2_0,并且在每个filter中可能还会有参数传递给这个fliter。</p>

<p>总的来说，通过pipeline装载多个filter,将最基本的app--APIRouter，层层包装，使其变为一个具有处理认证，扩展API等的应用（逻辑上看），filter的好处就是可以自定义，比如可以不要认证功能，这比写一个囊括全部功能的应用明显要好的多。</p>

<h2>2 代码实践</h2>

<h3>2.1 配置文件</h3>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>- awesome.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="o">[</span><span class="no">DEFAULT</span><span class="o">]</span>
</span><span class='line'><span class="n">company</span> <span class="o">=</span> <span class="no">UESTC</span>
</span><span class='line'><span class="n">school</span> <span class="o">=</span> <span class="no">Commuication</span> <span class="ow">and</span> <span class="no">Information</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;[composite:common]</span>
</span><span class='line'><span class="sr">use = egg:Paste#urlmap</span>
</span><span class='line'><span class="sr">/</span><span class="ss">:showversion</span>
</span><span class='line'><span class="sr">/detail:showdetail&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;[</span><span class="n">pipeline</span><span class="ss">:showdetail</span><span class="o">]</span>
</span><span class='line'><span class="n">pipeline</span> <span class="o">=</span> <span class="n">filter1</span> <span class="n">filter2</span> <span class="n">showstudetail</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;[filter:filter1]&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">filter1</span> <span class="n">deal</span> <span class="n">with</span> <span class="n">auth</span><span class="p">,</span><span class="n">read</span> <span class="n">args</span> <span class="n">below</span><span class="o">&lt;</span><span class="sr">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;paste.filter_factory = python_paste:AuthFilter.factory</span>
</span><span class='line'><span class="sr">user = admin</span>
</span><span class='line'><span class="sr">passwd = admin&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;[</span><span class="n">filter</span><span class="ss">:filter2</span><span class="o">]&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;h1&gt;filter2 deal with time,read args below&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="n">paste</span><span class="o">.</span><span class="n">filter_factory</span> <span class="o">=</span> <span class="n">python_paste</span><span class="ss">:LogFilter</span><span class="o">.</span><span class="n">factory</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;h1&gt;all value is string&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="n">date</span> <span class="o">=</span> <span class="mi">20121120</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;[app:showstudetail]</span>
</span><span class='line'><span class="sr">name = wangchang</span>
</span><span class='line'><span class="sr">age = 23</span>
</span><span class='line'><span class="sr">paste.app_factory = python_paste:ShowStuDetail.factory&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;[</span><span class="n">app</span><span class="ss">:showversion</span><span class="o">]</span>
</span><span class='line'><span class="n">version</span> <span class="o">=</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span>
</span><span class='line'><span class="n">paste</span><span class="o">.</span><span class="n">app_factory</span> <span class="o">=</span> <span class="n">python_paste</span><span class="ss">:ShowVersion</span><span class="o">.</span><span class="n">factory</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
从配置文件可以看出，这个程序会有如下操作：
*对于http://localhost/的访问，会调用showversion这个应用，应用读取ini文件中的version值并返回。__注意，在ini中的所有值都是字符串。</p>

<p>对于http://localhost/detail的访问，会先经过filter1以及filter2，这两个filter分别处理认证和LOG信息，他们会读取ini配置中的用户信息以及时间。最后才是交给showstudetail处理，showstudetail会读取ini中的用户信息并返回。__注意，使用多个filter的时候需要使用pipeline方式。</p>

<h3>2.2 代码</h3>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">os</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">webob</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">webob</span> <span class="kn">import</span> <span class="n">Request</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">webob</span> <span class="kn">import</span> <span class="n">Response</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="kn">from</span> <span class="nn">webob</span> <span class="kn">import</span> <span class="n">environ</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="kn">from</span> <span class="nn">paste.deploy</span> <span class="kn">import</span> <span class="n">loadapp</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">wsgiref.simple_server</span> <span class="kn">import</span> <span class="n">make_server</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">class</span> <span class="nc">AuthFilter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>  <span class="s">&#39;&#39;&#39;filter1,auth</span>
</span><span class='line'><span class="s">     1.factory read args and print,return self instance</span>
</span><span class='line'><span class="s">     2.call method return app</span>
</span><span class='line'><span class="s">     3.AuthFilter(app)</span>
</span><span class='line'><span class="s">  &#39;&#39;&#39;</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">app</span><span class="p">):</span>
</span><span class='line'>      <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">environ</span><span class="p">,</span><span class="n">start_response</span><span class="p">):</span>
</span><span class='line'>      <span class="k">print</span> <span class="s">&#39;this is Auth call filter1&#39;</span>
</span><span class='line'>      <span class="c">#pass environ and start_response to app</span>
</span><span class='line'>      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span><span class="n">start_response</span><span class="p">)</span>
</span><span class='line'>  <span class="nd">@classmethod</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">factory</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span><span class="n">global_conf</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span class='line'>      <span class="sd">&#39;&#39;&#39;global_conf and kwargs are dict&#39;&#39;&#39;</span>
</span><span class='line'>      <span class="k">print</span> <span class="s">&#39;######filter1##########&#39;</span>
</span><span class='line'>      <span class="k">print</span> <span class="s">&#39;global_conf type:&#39;</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="n">global_conf</span><span class="p">)</span>
</span><span class='line'>      <span class="k">print</span> <span class="s">&#39;[DEFAULT]&#39;</span><span class="p">,</span><span class="n">global_conf</span>
</span><span class='line'>      <span class="k">print</span> <span class="s">&#39;kwargs type:&#39;</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
</span><span class='line'>      <span class="k">print</span> <span class="s">&#39;Auth Info&#39;</span><span class="p">,</span><span class="n">kwargs</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">AuthFilter</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">class</span> <span class="nc">LogFilter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>  <span class="s">&#39;&#39;&#39;</span>
</span><span class='line'><span class="s">  filter2,Log</span>
</span><span class='line'><span class="s">  &#39;&#39;&#39;</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">app</span><span class="p">):</span>
</span><span class='line'>      <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">environ</span><span class="p">,</span><span class="n">start_response</span><span class="p">):</span>
</span><span class='line'>      <span class="k">print</span> <span class="s">&#39;This is call LogFilter filter2&#39;</span>
</span><span class='line'>      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span><span class="n">start_response</span><span class="p">)</span>
</span><span class='line'>  <span class="nd">@classmethod</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">factory</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span><span class="n">global_conf</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span class='line'>      <span class="c">#print type(global_conf)</span>
</span><span class='line'>      <span class="c">#print type(kwargs)</span>
</span><span class='line'>      <span class="k">print</span> <span class="s">&#39;######filter2###########&#39;</span>
</span><span class='line'>      <span class="k">print</span> <span class="s">&#39;[DEFAULT]&#39;</span><span class="p">,</span><span class="n">global_conf</span>
</span><span class='line'>      <span class="k">print</span> <span class="s">&#39;Log Info&#39;</span><span class="p">,</span><span class="n">kwargs</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">LogFilter</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">class</span> <span class="nc">ShowStuDetail</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>  <span class="s">&#39;&#39;&#39;</span>
</span><span class='line'><span class="s">  app</span>
</span><span class='line'><span class="s">  &#39;&#39;&#39;</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">age</span><span class="p">):</span>
</span><span class='line'>      <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</span><span class='line'>      <span class="bp">self</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">environ</span><span class="p">,</span><span class="n">start_response</span><span class="p">):</span>
</span><span class='line'>      <span class="k">print</span> <span class="s">&#39;this is call ShowStuDetail&#39;</span>
</span><span class='line'>      <span class="c">#pprint(environ)</span>
</span><span class='line'>      <span class="c">#pprint environ</span>
</span><span class='line'>      <span class="n">start_response</span><span class="p">(</span><span class="s">&quot;200 OK&quot;</span><span class="p">,[(</span><span class="s">&quot;Content-type&quot;</span><span class="p">,</span><span class="s">&quot;text/plain&quot;</span><span class="p">)])</span>
</span><span class='line'>      <span class="n">content</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>      <span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;name: </span><span class="si">%s</span><span class="s"> age:</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">age</span><span class="p">))</span>
</span><span class='line'>      <span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;**********WSGI INFO***********</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">environ</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
</span><span class='line'>          <span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s"> </span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">))</span>
</span><span class='line'>      <span class="k">return</span> <span class="p">[</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">content</span><span class="p">)]</span> <span class="c">#return a list</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@classmethod</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">factory</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span><span class="n">global_conf</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span class='line'>      <span class="c">#self.name = kwargs[&#39;name&#39;]</span>
</span><span class='line'>      <span class="c">#self.age = kwargs[&#39;age&#39;]</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">ShowStuDetail</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;age&#39;</span><span class="p">])</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">class</span> <span class="nc">ShowVersion</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>  <span class="s">&#39;&#39;&#39;</span>
</span><span class='line'><span class="s">  app</span>
</span><span class='line'><span class="s">  &#39;&#39;&#39;</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">version</span><span class="p">):</span>
</span><span class='line'>      <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">environ</span><span class="p">,</span><span class="n">start_response</span><span class="p">):</span>
</span><span class='line'>      <span class="k">print</span> <span class="s">&#39;this is call ShowVersion&#39;</span>
</span><span class='line'>      <span class="n">req</span> <span class="o">=</span> <span class="n">Request</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>
</span><span class='line'>      <span class="n">res</span> <span class="o">=</span> <span class="n">Response</span><span class="p">()</span>
</span><span class='line'>      <span class="n">res</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">&#39;200 OK&#39;</span>
</span><span class='line'>      <span class="n">res</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="s">&quot;text/plain&quot;</span>
</span><span class='line'>      <span class="n">content</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>      <span class="c">#pprint(req.environ)</span>
</span><span class='line'>      <span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
</span><span class='line'>      <span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;*********WSGI INFO*********&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">environ</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
</span><span class='line'>          <span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">))</span>
</span><span class='line'>      <span class="n">res</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">res</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span><span class="n">start_response</span><span class="p">)</span>
</span><span class='line'>  <span class="nd">@classmethod</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">factory</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span><span class="n">global_conf</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span class='line'>      <span class="c">#self.version = kwargs[&#39;version&#39;]</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">ShowVersion</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;version&#39;</span><span class="p">])</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">if</span> <span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">name</span><span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span> <span class="o">==</span> <span class="s">&#39;&lt;strong&gt;main&lt;/strong&gt;&#39;</span><span class="p">:</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span> <span class="n">config</span> <span class="o">=</span> <span class="s">&quot;python_paste.ini&quot;</span>
</span><span class='line'> <span class="n">appname</span> <span class="o">=</span> <span class="s">&quot;common&quot;</span>
</span><span class='line'> <span class="n">wsgi_app</span> <span class="o">=</span> <span class="n">loadapp</span><span class="p">(</span><span class="s">&quot;config:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">config</span><span class="p">),</span> <span class="n">appname</span><span class="p">)</span>
</span><span class='line'> <span class="n">server</span> <span class="o">=</span> <span class="n">make_server</span><span class="p">(</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span><span class="mi">7070</span><span class="p">,</span><span class="n">wsgi_app</span><span class="p">)</span>
</span><span class='line'> <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</span><span class='line'> <span class="k">pass</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>在程序中，对于web请求的处理，我分别采用了webob和普通WSGI定义的方式，后续我会补上webob的使用。</p>

<h3>2.3 结果</h3>

<p>先从服务端结果分析一下调用流程：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Ubuntu:~/python$ python python_paste.py&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;h6>filter1&lt;/h6>
</span><span class='line'>
</span><span class='line'>&lt;p>global_conf type: &lt;type 'dict'>
</span><span class='line'>[DEFAULT] {'school': 'Commuication and Information', 'company': 'UESTC', 'here': '/home/wachang/python', '&lt;strong>file&lt;/strong>': '/home/wachang/python/python_paste.ini'}
</span><span class='line'>kwargs type: &lt;type 'dict'>
</span><span class='line'>Auth Info {'passwd': 'admin', 'user': 'admin'}&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;h6>filter2&lt;/h6>
</span><span class='line'>
</span><span class='line'>&lt;p>[DEFAULT] {'school': 'Commuication and Information', 'company': 'UESTC', 'here': '/home/wachang/python', '&lt;strong>file&lt;/strong>': '/home/wachang/python/python_paste.ini'}
</span><span class='line'>Log Info {'date': '20121120'}
</span><span class='line'>以上是PD载入应用时，调用filter的factory方法输出的结果，可以看到，此读出了相关的变量信息。&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>this is call ShowVersion
</span><span class='line'>localhost - - [21/Nov/2012 13:23:40] "GET / HTTP/1.1" 200 2938
</span><span class='line'>this is call ShowVersion
</span><span class='line'>localhost - - [21/Nov/2012 13:23:40] "GET /favicon.ico HTTP/1.1" 200 2889
</span><span class='line'>以上是接收/请求，因为没有使用filter，直接交予showversion应用处理，并返回。&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>this is Auth call filter1
</span><span class='line'>This is call LogFilter filter2
</span><span class='line'>this is call ShowStuDetail
</span><span class='line'>localhost - - [21/Nov/2012 13:24:23] "GET /detail HTTP/1.1" 200 3016
</span><span class='line'>this is call ShowVersion
</span><span class='line'>localhost - - [21/Nov/2012 13:24:24] "GET /favicon.ico HTTP/1.1" 200 2889
</span><span class='line'>filter的调用时重点啊，可以看到，调用的顺序和pipeline中一样。最后才调用应用。</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<blockquote><p>需要继续折腾的话，就看看<a href="http://docs.webob.org/en/latest/do-it-yourself.html">webob:do-it-yourselfrself</a></p></blockquote>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Python.Paste指南之Deploy(1)-概念]]></title>
    <link href="http://wangchang.github.com/blog/2012/11/python-paste-one-deploy-1/"/>
    <updated>2012-11-17T13:24:00+08:00</updated>
    <id>http://wangchang.github.com/blog/2012/11/python-paste-one-deploy-1</id>
    <content type="html"><![CDATA[<p>Paste.Deploy主要是用来载入WSGI中的Web App使用，其核心函数是loadapp(),下文中PD就指代Paste.Deploy。</p>

<blockquote><p>OS:Ubuntu12.04 2012年11月17日 第一版
主要是对官方文档的一个翻译，外加自己的一些理解
本文的Paste.Deploy使用主要是针对WSGI</p></blockquote>

<h2>1 简介及安装</h2>

<p>Paste Deployment是一种机制，通过loadapp函数和一个配置文件或者egg包来载入WSGI应用。安装很简单，如下两种方式：
<div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pip install PasteDeploy</span></code></pre></td></tr></table></div></figure></notextile></div>
或者可以从github上进行源码安装
<div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ hg clone http://bitbucket.org/ianb/pastedeploy
</span><span class='line'>$ cd pastedeploy
</span><span class='line'>$ sudo python setup.py develop</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<!--more-->


<h2>2 配置文件Config Flie</h2>

<p>一个配置文件后缀为ini，内容被分为很多段（section），PD只关心带有前缀的段，比如<code>[app:main]</code>或者<code>[filter:errors]</code>，总的来说，一个section的标识就是<code>[type:name]</code>,不是这种类型的section将会被忽略。</p>

<p>一个section的内容是以<code>键=值</code>来标示的。#是一个注释。在段的定义中，有以下几类：</p>

<ul>
<li><p>[app:main]:定义WSGI应用，main表示只有一个应用，有多个应用的话main改为应用名字</p></li>
<li><p>[server:main]:定义WSGI的一个server。</p></li>
<li><p>[composite:xxx]：表示需要将一个请求调度定向（dispatched）到多个,或者多种应用上。以下是一个简单的例子，例子中，使用了composite，通过urlmap来实现载入多应用。</p></li>
<li><p>[fliter:]：定义“过滤器”，将应用进行进一步的封装。</p></li>
<li><p>[DEFAULT]：定义一些默认变量的值。</p></li>
</ul>


<p>以下是一个例子：
<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>- awesome.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="o">[</span><span class="n">composite</span><span class="ss">:main</span><span class="o">]</span>
</span><span class='line'><span class="n">use</span> <span class="o">=</span> <span class="n">egg</span><span class="ss">:Paste</span><span class="c1">#urlmap</span>
</span><span class='line'><span class="sr">/ = home</span>
</span><span class='line'><span class="sr">/</span><span class="n">blog</span> <span class="o">=</span> <span class="n">blog</span>
</span><span class='line'><span class="sr">/wiki = wiki</span>
</span><span class='line'><span class="sr">/</span><span class="n">cms</span> <span class="o">=</span> <span class="n">config</span><span class="ss">:cms</span><span class="o">.</span><span class="n">ini</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;[app:home]</span>
</span><span class='line'><span class="sr">use = egg:Paste#static</span>
</span><span class='line'><span class="sr">document_root = %(here)s/</span><span class="n">htdocs</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;[filter-app:blog]</span>
</span><span class='line'><span class="sr">use = egg:Authentication#auth</span>
</span><span class='line'><span class="sr">next = blogapp</span>
</span><span class='line'><span class="sr">roles = admin</span>
</span><span class='line'><span class="sr">htpasswd = /</span><span class="n">home</span><span class="o">/</span><span class="n">me</span><span class="o">/</span><span class="n">users</span><span class="o">.</span><span class="n">htpasswd</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;[app:blogapp]</span>
</span><span class='line'><span class="sr">use = egg:BlogApp</span>
</span><span class='line'><span class="sr">database = sqlite:/</span><span class="n">home</span><span class="o">/</span><span class="n">me</span><span class="o">/</span><span class="n">blog</span><span class="o">.</span><span class="n">db</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;[app:wiki]</span>
</span><span class='line'><span class="sr">use = call:mywiki.main:application</span>
</span><span class='line'><span class="sr">database = sqlite:/</span><span class="n">home</span><span class="o">/</span><span class="n">me</span><span class="o">/</span><span class="n">wiki</span><span class="o">.</span><span class="n">db</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
下面会进行分段的讲解</p>

<h3>2.1 composite</h3>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>- awesome.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="o">[</span><span class="n">composite</span><span class="ss">:main</span><span class="o">]</span>
</span><span class='line'><span class="n">use</span> <span class="o">=</span> <span class="n">egg</span><span class="ss">:Paste</span><span class="c1">#urlmap</span>
</span><span class='line'><span class="sr">/ = home</span>
</span><span class='line'><span class="sr">/</span><span class="n">blog</span> <span class="o">=</span> <span class="n">blog</span>
</span><span class='line'><span class="sr">/wiki = wiki</span>
</span><span class='line'><span class="sr">/</span><span class="n">cms</span> <span class="o">=</span> <span class="n">config</span><span class="ss">:cms</span><span class="o">.</span><span class="n">ini</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
这是一个composite段，表示这将会根据一些条件将web请求调度到不同的应用。<code>use = egg:Paste#urlmap</code>表示我们奖使用<code>Paste</code>egg包中<code>urlmap</code>来实现composite，这一个段(urlmap)可以算是一个通用的composite程序了。根据web请求的path的前缀进行一个到应用的映射(map)。这些被映射的程序就包括blog,home,wiki,config:cms.ini（映射到了另外一个配置文件，PD再根据这个文件进行载入）</p>

<h3>2.2 App type1</h3>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>- awesome.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="o">[</span><span class="n">app</span><span class="ss">:home</span><span class="o">]</span>
</span><span class='line'><span class="n">use</span> <span class="o">=</span> <span class="n">egg</span><span class="ss">:Paste</span><span class="c1">#static</span>
</span><span class='line'><span class="n">document_root</span> <span class="o">=</span> <span class="sx">%(here)</span><span class="n">s</span><span class="o">/</span><span class="n">htdocs</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
app是一个callable object，接受的参数(environ,start_response)，这是paste系统交给application的，符合WSGI规范的参数. app需要完成的任务是响应envrion中的请求，准备好响应头和消息体，然后交给start_response处理，并返回响应消息体。<code>egg:Paste#static</code>也是Paste包中的一个简单程序，它只处理静态文件。它需要一个配置文件document_root,后面的值可以是一个变量,形式为%（var）s相应的值应该在[DEFAULT]字段指明以便Paste读取。比如：
<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>- awesome.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="o">[</span><span class="n">app</span><span class="ss">:test</span><span class="o">]</span>
</span><span class='line'><span class="n">use</span> <span class="o">=</span> <span class="n">egg</span><span class="ss">:Paste</span><span class="c1">#static</span>
</span><span class='line'><span class="n">document_root</span> <span class="o">=</span> <span class="sx">%(path)</span><span class="n">s</span><span class="o">/</span><span class="n">htdocs</span>
</span><span class='line'><span class="o">[</span><span class="no">DEFAULT</span><span class="o">]</span>
</span><span class='line'><span class="n">path</span> <span class="o">=</span> <span class="sr">/etc/</span><span class="nb">test</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h3>2.3 fliter</h3>

<p>filter是一个callable object，其唯一参数是(app)，这是WSGI的application对象，filter需要完成的工作是将application包装成另一个application（“过滤”），并返回这个包装后的application。
<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>- awesome.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="o">[</span><span class="n">filter</span><span class="o">-</span><span class="n">app</span><span class="ss">:blog</span><span class="o">]</span>
</span><span class='line'><span class="n">use</span> <span class="o">=</span> <span class="n">egg</span><span class="ss">:Authentication</span><span class="c1">#auth</span>
</span><span class='line'><span class="k">next</span> <span class="o">=</span> <span class="n">blogapp</span>
</span><span class='line'><span class="n">roles</span> <span class="o">=</span> <span class="n">admin</span>
</span><span class='line'><span class="n">htpasswd</span> <span class="o">=</span> <span class="sr">/home/me</span><span class="o">/</span><span class="n">users</span><span class="o">.</span><span class="n">htpasswd</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;[app:blogapp]</span>
</span><span class='line'><span class="sr">use = egg:BlogApp</span>
</span><span class='line'><span class="sr">database = sqlite:/</span><span class="n">home</span><span class="o">/</span><span class="n">me</span><span class="o">/</span><span class="n">blog</span><span class="o">.</span><span class="n">db</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<code>[filter-app:blog]</code>fliter-app字段表明你希望对某个应用进行包装，需要包装的应用通过next指明（表明在下一个段中），这个字段的意思就是，在正式调用blogapp之前，我会调用egg:Authentication#auth进行一个用户的验证，随后才会调用blogapp进行处理。后面的[app:blogapp]则是定义了blogapp，并指明了需要的database参数。</p>

<h3>2.4 App type2</h3>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>- awesome.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="o">[</span><span class="n">app</span><span class="ss">:wiki</span><span class="o">]</span>
</span><span class='line'><span class="n">use</span> <span class="o">=</span> <span class="n">call</span><span class="ss">:mywiki</span><span class="o">.</span><span class="n">main</span><span class="ss">:application</span>
</span><span class='line'><span class="n">database</span> <span class="o">=</span> <span class="n">sqlite</span><span class="ss">:/</span><span class="n">home</span><span class="o">/</span><span class="n">me</span><span class="o">/</span><span class="n">wiki</span><span class="o">.</span><span class="n">db</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
这个段和之前的app段定义类似，不同的是对于wiki这个应用，我们没有使用egg包，而是直接对mywiki.main这个模块中的application对象使用了call方法。python，中一切皆对象，作为WSGI app的可以是一个函数，一个类，或者一个实例，使用call的话，相应的函数，类，实例中必须实现<strong>call</strong>()方法。此类app的格式用冒号分割: <code>call(表示使用call方法):模块的完成路径名字:应用变量的完整名字</code></p>

<h2>3 基本使用</h2>

<p>PD的主要使用就是通过读取配置文件载入WSGI应用。如下：
<div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>from paste.deploy import loadapp
</span><span class='line'>wsgi_app = loadapp('config:/path/to/config.ini')</span></code></pre></td></tr></table></div></figure></notextile></div>
注意，这里需要指明绝对路径。</p>

<h2>4 更多关于配置文件</h2>

<h3>4.1 App</h3>

<p>单个配置文件中可以定义多个应用个，每个应用有自己独立的段。应用的定义以[app:name]的格式，[app:main]表示只有一个应用。应用的定义支持以下五种格式：
<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>- awesome.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="o">[</span><span class="n">app</span><span class="ss">:myapp</span><span class="o">]</span>
</span><span class='line'><span class="n">use</span> <span class="o">=</span> <span class="n">config</span><span class="ss">:another_config_file</span><span class="o">.</span><span class="n">ini</span><span class="c1">#app_name&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="err">使用另外一个配置文件</span><span class="o">&lt;</span><span class="sr">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;[app:myotherapp]</span>
</span><span class='line'><span class="sr">use = egg:MyApp&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="err">使用</span><span class="n">egg</span><span class="err">包中的内容</span><span class="o">&lt;</span><span class="sr">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;[app:mythirdapp]</span>
</span><span class='line'><span class="sr">use = call:my.project:myapplication&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="err">使用模块中的</span><span class="n">callable</span><span class="err">对象</span><span class="o">&lt;</span><span class="sr">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;[app:mylastapp]</span>
</span><span class='line'><span class="sr">use = myotherapp&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="err">使用另外一个</span><span class="n">section</span><span class="o">&lt;</span><span class="sr">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;[app:myfacapp]</span>
</span><span class='line'><span class="sr">paste.app_factory = myapp.modulename:app_factory&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="err">使用工厂函数</span><span class="o">&lt;</span><span class="sr">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
其中，最后一种方式，将一个app指向了某些python代码。此模式下，必须执行app协议，以app_factory表示，后面的值需要import的东西，在这个例子中myapp.modulename被载入，并从其中取得了app_factory的实例。</p>

<p>app_factory是一个callable object，其接受的参数是一些关于application的配置信息：<code>(global_conf,**kwargs)</code>，<code>global_conf</code>是在ini文件中default section中定义的一系列key-value对，而<code>**kwargs</code>，即一些本地配置，是在ini文件中，app:xxx section中定义的一系列key-value对。app_factory返回值是一个application对象</p>

<p>在app的配置中，use参数以后配置就算结束了。其余的键值参数将会作为参数，传递到factory中，如下：</p>

<pre><code>[app:blog]
use = egg:MyBlog
database = mysql://localhost/blogdb #这是参数
blogname = This Is My Blog! #这是参数
</code></pre>

<h3>4.2 全局配置</h3>

<p>全局配置主要是用于多个应用共用一些变量，这些变量我们规定放在段[DEFAULT]中，如果需要覆盖，可以在自己的app中重新定义，如下：</p>

<pre><code>[DEFAULT]
admin_email = webmaster@example.com
[app:main]
use = ...
set admin_email = bob@example.com
</code></pre>

<h3>4.3 composite app</h3>

<p>composite是一个运行着像是app，但是实际上是由多个应用组成的。urlmap就是composite app的一个例子，url不同的path对应了不同的应用。如下：</p>

<pre><code>[composite:main]
use = egg:Paste#urlmap
/ = mainapp
/files = staticapp

[app:mainapp]
use = egg:MyApp

[app:staticapp]
use = egg:Paste#static
document_root = /path/to/docroot
</code></pre>

<p>在loadapp函数的执行中，composite app被实例化，它同时还会访问配置文件中定义的其他应用。</p>

<h3>4.4 app定义高级用法</h3>

<p>在app段中，你可以定义fliters和servers，通过<code>fliter:</code>和<code>server:</code> PD通过loadserver和loadfilter函数进行调用，工作机制都一样，返回不同的对象。</p>

<h4>4.4.1 filter composition</h4>

<p>应用filter的方式很多，重要的是看你filter的数量和组织形式。下面会一一介绍应用fliter的几种方式：</p>

<p>1.使用<code>filter-with</code></p>

<pre><code>[app:main]
use = egg:MyEgg
filter-with = printdebug

[filter:printdebug]
use = egg:Paste#printdebug
# and you could have another filter-with here, and so on...
</code></pre>

<p>2.使用<code>fliter-app</code></p>

<pre><code>[fliter-app:printdebug]
use = egg:Paste
next = main

[app:main]
use = egg:MyEgg
</code></pre>

<p>3.使用pipeline</p>

<p>当使用多个filter的时候需要使用pipeline的方式，它需要提供一个key参数pipeline,后面的值是一个列表，最后以应用结尾。如下：</p>

<pre><code>[pipeline:main]
pipeline = filter1 egg:FilterEgg#filter2 filter3 app

[filter:filter1]
...
</code></pre>

<p>假设在ini文件中, 某条pipeline的顺序是filter1, filter2, filter3，app, 那么，最终运行的app_real是这样组织的：
app_real = filter1(filter2(filter3(app)))</p>

<p>在app真正被调用的过程中，filter1._<em>call_</em>(environ,start_response)被首先调用，若某种检查未通过，filter1做出反应；否则交给filter2._<em>call_</em>(environ,start_response)进一步处理，若某种检查未通过，filter2做出反应，中断链条，否则交给filter3._<em>call_</em>(environ,start_response)处理，若filter3的某种检查都通过了，最后交给app._<em>call_</em>(environ,start_response)进行处理。</p>

<h3>4.5 读取配置文件</h3>

<p>如果希望在不创建应用的情况下得到配置文件，可以使用appconfig(uri)函数，将会以字典形式返回使用的配置。这个字典包括了全局很本地的配置信息，所以可以通过属性方法获得相应的attributes （.local_conf and .global_conf）</p>

<h2>5 其他</h2>

<h3>5.1 如何引用Egg包</h3>

<p>egg是python的一个包，pip easy_install等都是安装egg包的方式。关注egg包要注意：
+某一egg包是有标准说明的</p>

<p>python setup.py name
+有entry point，不用太在意，这个只是说明调用程序的参数。</p>

<h3>5.2 定义factory函数</h3>

<p>工厂函数的定义还是遵循之前提到的应用的协议。目前，用于工厂函数的协议有以下：</p>

<p>*paste.app_factory</p>

<p>*paste.composite_factory</p>

<p>*paste.filter_factory</p>

<p>*paste.server_factory</p>

<p>所有的这些都希望有一个含有__call__方法的（函数，方法，类）。</p>

<p>1.<code>paste.app_factory</code></p>

<pre><code>def app_factory(global_config, **local_conf):
    return wsgi_app
</code></pre>

<p>global_config是一个字典，而local_conf则是关键字参数。返回一个wsgi_app（含有<strong>call</strong>方法。）</p>

<p>2.paste.composite_factory`</p>

<pre><code>def composite_factory(loader, global_config, **local_conf):
   return wsgi_app
</code></pre>

<p>loader是一个对象，有几个有趣的方法,get_app(name_or_uri, global_conf=None)根据name返回一个wsgi应用，get_filter（）和get_server（）也是一样。看一个更加复杂的例子，举例一个pipeline应用：</p>

<pre><code>def pipeline_factory(loader, global_config, pipeline):
    # space-separated list of filter and app names:
    pipeline = pipeline.split()
    filters = [loader.get_filter(n) for n in pipeline[:-1]]
    app = loader.get_app(pipeline[-1])
    filters.reverse() # apply in reverse order!
    for filter in filters:
      app = filter(app)
    return app
</code></pre>

<p>相应的配置文件如下：
<div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[composite:main]
</span><span class='line'>use = &lt;pipeline_factory_uri>
</span><span class='line'>pipeline = egg:Paste#printdebug session myapp&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>[filter:session]
</span><span class='line'>use = egg:Paste#session
</span><span class='line'>store = memory&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>[app:myapp]
</span><span class='line'>use = egg:MyApp</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>3.<code>paste.filter_factory</code>
fliter的工厂函数和app的共产函数类似，除了它返回的是一个filter,fliter是一个仅仅把一个wsgi应用作为唯一参数的callable对象，返回一个被filter了的应用。
以下是一个例子，这个filter会检查CGI中REMOTE_USER变量是否存在，并创建一个简单的认证过滤器。</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def auth_filter_factory(global_conf, req_usernames):&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code># space-separated list of usernames:
</span><span class='line'>req_usernames = req_usernames.split()
</span><span class='line'>def filter(app):
</span><span class='line'>    return AuthFilter(app, req_usernames)
</span><span class='line'>return filter
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>class AuthFilter(object):&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>def __init__(self, app, req_usernames):
</span><span class='line'>    self.app = app
</span><span class='line'>    self.req_usernames = req_usernames
</span><span class='line'>
</span><span class='line'>def __call__(self, environ, start_response):
</span><span class='line'>    if environ.get('REMOTE_USER') in self.req_usernames:
</span><span class='line'>        return self.app(environ, start_response)
</span><span class='line'>    start_response(
</span><span class='line'>        '403 Forbidden', [('Content-type', 'text/html')])
</span><span class='line'>    return ['You are forbidden to view this resource']
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p></span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>4.<code>paste.filter_app_factory</code>
和paste.filter_factory类似，接受一个wsgi应用参数，返回一个WSGI应用，所以如果改变以上代码的：</p>

<pre><code>class AuthFilter(object):
    def __init__(self, app, global_conf, req_usernames):
        ....
</code></pre>

<p>那么，类 AuthFilter就会作为一个filter_app_factory函数使用。</p>

<p>5.<code>paste.server_factory</code></p>

<p>与以上不同的是，函数返回的是一个server,一个server也是一个callable对象，以一个WSGI应用作为参数，而后为这个应用服务。</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">server_factory</span><span class="p">(</span><span class="n">global_conf</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">serve</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
</span><span class='line'>    <span class="n">s</span> <span class="o">=</span> <span class="n">Server</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>
</span><span class='line'>    <span class="n">s</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</span><span class='line'><span class="k">return</span> <span class="n">serve</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Server的实现用户可以自定义，可以参考python包wsgiref</p>

<p>6.<code>paste.server_runner</code>
与 paste.server_factory类似，不同的是参数格式。</p>

<h2>6 其他一些值得讨论的问题</h2>

<p>ConfigParser（PD底层用到这个来解析ini文件）解析ini文件不是很有效率，是否需要更改？</p>

<p>在配置文件中的对象是否需要是python风格的，而不是字符串的形式？</p>

<blockquote><p>Paste Deployment currently does not require other parts of Paste, and is distributed as a separate package.</p></blockquote>

<p><a href="http://pythonpaste.org/deploy/#defining-factories">http://pythonpaste.org/deploy/#defining-factories</a>
<a href="http://pythonpaste.org/deploy/">http://pythonpaste.org/deploy/</a>
<a href="http://pythonpaste.org/script/#paster-serve">http://pythonpaste.org/script/#paster-serve</a>
<a href="http://kevinzheng.sinaapp.com/?p=104">http://kevinzheng.sinaapp.com/?p=104</a>
<a href="http://blog.csdn.net/icycolawater/article/details/7045287">http://blog.csdn.net/icycolawater/article/details/7045287</a></p>
]]></content>
  </entry>
  
</feed>
